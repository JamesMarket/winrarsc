name: ğŸ”„ ç»ˆæå…¨è‡ªåŠ¨åŒæ­¥ (é€šç”¨ç‰ˆ)

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ›°ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– è‡ªåŠ¨è¯†åˆ«ä¸Šæ¸¸å¹¶åŒæ­¥
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "=== æ­£åœ¨è‡ªåŠ¨è¯†åˆ«ä¸Šæ¸¸ä»“åº“ ==="
          
          # å°è¯•æ–¹æ³• 1: GH CLI (ä½ ä¹‹å‰å¤±è´¥çš„æ–¹æ³•)
          UPSTREAM_URL=$(gh repo view ${{ github.repository }} --json parent -q ".parent.clone_url" 2>/dev/null || echo "")
          
          # å°è¯•æ–¹æ³• 2: ç›´æ¥è¯·æ±‚ GitHub REST API (æ›´åº•å±‚ï¼ŒæˆåŠŸç‡æ›´é«˜)
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "âš ï¸ GH CLI æœªèƒ½è·å–çˆ¶ä»“åº“ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ REST API..."
            UPSTREAM_URL=$(curl -s -H "Authorization: token $GH_TOKEN" \
              https://api.github.com/repos/${{ github.repository }} \
              | jq -r '.parent.clone_url // empty')
          fi

          # ç»“æœæ£€æŸ¥
          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šGitHub API åšæŒè®¤ä¸ºæ­¤ä»“åº“æ²¡æœ‰çˆ¶ä»“åº“ï¼ˆParentï¼‰ã€‚"
            echo "è¿™é€šå¸¸æ„å‘³ç€ Fork å…³ç³»åœ¨ GitHub åç«¯å·²æ–­å¼€ã€‚"
            exit 1
          fi

          echo "âœ… æˆåŠŸè¯†åˆ«ä¸Šæ¸¸åœ°å€: $UPSTREAM_URL"

          # è·å–é»˜è®¤åˆ†æ”¯å (master æˆ– main)
          DEFAULT_BRANCH=$(git branch --show-current)
          echo "âœ… ç›®æ ‡åŒæ­¥åˆ†æ”¯: $DEFAULT_BRANCH"

          # é…ç½® Git ç¯å¢ƒ
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # æ·»åŠ ä¸Šæ¸¸å¹¶æ‰§è¡ŒåŒæ­¥
          git remote add upstream "$UPSTREAM_URL"
          git fetch upstream "$DEFAULT_BRANCH"

          # å¼ºåˆ¶åˆå¹¶ï¼ˆä»¥åŸä½œè€…ä¸ºå‡†ï¼‰
          echo "=== æ­£åœ¨æ‰§è¡Œåˆå¹¶ä»»åŠ¡ ==="
          git checkout "$DEFAULT_BRANCH"
          if git merge upstream/"$DEFAULT_BRANCH" --ff-only; then
            echo "ğŸš€ åŒæ­¥æˆåŠŸ (Fast-forward)"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°å†²çªï¼Œæ‰§è¡Œå¼ºåˆ¶è¦†ç›–ä»¥ä¿æŒä¸åŸä½œè€…ä¸€è‡´ã€‚"
            git reset --hard upstream/"$DEFAULT_BRANCH"
          fi

          # æ¨é€å› origin
          git push origin "$DEFAULT_BRANCH" --force
