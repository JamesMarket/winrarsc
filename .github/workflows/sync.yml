name: ğŸ”„ ç»ˆæå…¨è‡ªåŠ¨åŒæ­¥

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  universal-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ›°ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ¤– è‡ªåŠ¨è¯†åˆ«å¹¶åŒæ­¥
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è‡ªåŠ¨è·å–çˆ¶ä»“åº“åœ°å€å’Œå½“å‰åˆ†æ”¯
          REPO_INFO=$(gh repo view ${{ github.repository }} --json parent,defaultBranchRef)
          UPSTREAM_URL=$(echo $REPO_INFO | jq -r '.parent.clone_url // empty')
          CURRENT_BRANCH=$(echo $REPO_INFO | jq -r '.defaultBranchRef.name')

          if [ -z "$UPSTREAM_URL" ] || [ "$UPSTREAM_URL" = "null" ]; then
            echo "âŒ é”™è¯¯ï¼šæ­¤ä»“åº“åœ¨ GitHub API ä¸­æ²¡æœ‰çˆ¶ä»“åº“è®°å½•ï¼ˆå¯èƒ½æ˜¯è„±ç¦»å…³ç³»çš„ Forkï¼‰ã€‚"
            echo "ğŸ’¡ å»ºè®®ï¼šè¯·æ‰‹åŠ¨æ£€æŸ¥è¯¥ä»“åº“æ˜¯å¦æ˜¯é€šè¿‡ç‚¹å‡» GitHub å®˜æ–¹ 'Fork' æŒ‰é’®åˆ›å»ºçš„ã€‚"
            exit 1
          fi

          echo "âœ… è¯†åˆ«åˆ°ä¸Šæ¸¸ï¼š$UPSTREAM_URL"
          echo "âœ… å½“å‰ä¸»åˆ†æ”¯ï¼š$CURRENT_BRANCH"

          # 2. é…ç½® Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # 3. æ·»åŠ è¿œç¨‹åˆ†æ”¯å¹¶å¼ºåˆ¶åŒæ­¥
          git remote add upstream "$UPSTREAM_URL"
          git fetch upstream "$CURRENT_BRANCH"
          
          # å°è¯•å¿«è¿›åˆå¹¶ï¼Œå¦‚æœå¤±è´¥åˆ™å¼ºè¡Œè¦†ç›–ï¼ˆä¿æŒè·ŸåŸä½œè€…å®Œå…¨ä¸€è‡´ï¼‰
          git checkout "$CURRENT_BRANCH"
          if git merge upstream/"$CURRENT_BRANCH" --ff-only; then
            echo "ğŸš€ å·²é€šè¿‡å¿«è¿›æ¨¡å¼åŒæ­¥æˆåŠŸã€‚"
          else
            echo "âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°æœ‰æ”¹åŠ¨æˆ–å†²çªï¼Œæ‰§è¡Œå¼ºè¡Œè¦†ç›–ï¼Œä»¥ä¿æŒä¸åŸä½œè€…ä¸€è‡´ã€‚"
            git reset --hard upstream/"$CURRENT_BRANCH"
          fi

          # 4. æ¨é€å›è‡ªå·±çš„ä»“åº“
          git push origin "$CURRENT_BRANCH" --force
